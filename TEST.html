<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Random Game</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root {
      --primary: #5865f2;
      --accent: #43b581;
      --bg: #23272a;
      --bg2: #2c2f33;
      --text: #fff;
      --text-muted: #b9bbbe;
      --error: #ff5555;
      --border: #444;
      --elevate: 0 8px 32px rgba(0,0,0,0.23);
      --radius: 18px;
      --radius-lg: 32px;
      --shadow: 0 2px 24px rgba(80,80,100,0.12);
    }
    html, body {
      min-height: 100%;
      background: linear-gradient(135deg, #181c20 0%, #23272a 60%, #5865f2 120%);
      color: var(--text);
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      justify-content: flex-start;
    }
    .quiz-box {
      background: var(--bg2);
      border-radius: var(--radius);
      padding: 36px 30px 28px 30px;
      margin: 36px auto 0 auto;
      box-shadow: var(--shadow);
      max-width: 430px;
      min-width: 296px;
      width: 96vw;
      transition: box-shadow 0.15s;
    }
    .quiz-box h2 {
      font-weight: 800;
      letter-spacing: 0.04em;
      color: var(--primary);
      margin: 0 0 20px 0;
      font-size: 2.15em;
      text-shadow: 0 2px 10px #181a22a0;
    }
    .big-count {
      font-size: 2.1em;
      margin: 22px auto 14px auto;
      font-weight: bold;
      color: #ffeb3b;
      text-shadow: 1px 2px 11px #181a22;
      border-radius: var(--radius);
      background: linear-gradient(90deg, #222 70%, #2220 100%);
      border: 1.5px solid #4442;
      padding: 5px 0 10px 0;
    }
    input, button {
      font-size: 1.15em;
      padding: 10px 14px;
      border-radius: 7px;
      border: 1px solid #23253c;
      background: #22242b;
      color: var(--text);
      margin-top: 10px;
      outline: none;
      transition: border 0.13s, box-shadow 0.13s;
      box-sizing: border-box;
    }
    input:focus {
      border: 1.5px solid var(--primary);
      background: #212430;
    }
    button {
      background: var(--primary);
      border: none;
      color: #fff;
      box-shadow: 0 2px 8px #5865f23e;
      font-weight: 700;
      cursor: pointer;
      margin-top: 18px;
      transition: background .18s, box-shadow .14s;
    }
    button:hover {
      background: #4752c4;
      box-shadow: 0 2px 16px #5865f271;
    }
    #leaderboard {
      background: var(--bg2);
      color: var(--text);
      border: 2px solid var(--border);
      border-radius: var(--radius);
      margin: 38px auto 0 auto;
      padding: 16px 18px 22px 18px;
      max-width: 530px;
      width: 99vw;
      box-shadow: var(--shadow);
      text-align: left;
    }
    #leaderboard h3 {
      margin: 0 0 10px 0;
      text-align: center;
      font-size: 1.18em;
      font-weight: 700;
      color: var(--primary);
    }
    #leaderboard table {
      width: 100%;
      border-collapse: collapse;
      background: transparent;
    }
    #leaderboard th, #leaderboard td {
      padding: 6px 8px;
      border-bottom: 1px solid #393c49;
      text-align: left;
      font-size: 1em;
    }
    #leaderboard th {
      background: #262b33;
      font-weight: 900;
      color: var(--text);
      letter-spacing: 0.02em;
    }
    #leaderboard tr:last-child td {
      border-bottom: none;
    }
    #accountBox { margin-bottom: 10px;}
    #accountBox input { margin-right: 7px; font-size: 1em; padding: 7px 12px;}
    #errorMsg { color: var(--error); margin-top: 10px; font-weight: 600;}
    #accountSwitch, #accountSwitchBack {
      color: var(--primary);
      cursor: pointer;
      text-decoration: underline;
      font-size: 0.97em;
      font-weight: 600;
    }
    #showPasswordBox { display: none; margin-top: 28px; text-align: left;}
    #showPasswordLabel { font-size: 0.97em; color: #aaf; cursor: pointer;}
    #rememberMsg { font-size: 1.09em; color: #ffe; margin-top: 7px; margin-left: 0px; text-align: left;}
    #logoutBtn { color:var(--primary); cursor:pointer; text-decoration:underline; font-weight:600;}
    #timerBox {
      margin: 28px 0 26px 0;
      color: var(--accent);
      font-size: 4em;
      font-weight: bold;
      letter-spacing: 2px;
      background: #1b201c99;
      box-shadow: 0 2px 17px #181c20c0;
      padding: 15px 12px 10px 12px;
      border-radius: 20px;
      border: 1.5px solid #42474b;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      min-width: 0;
    }
    #timerLabel {
      font-size: 0.34em;
      color: #fff;
      margin-bottom: 6px;
      letter-spacing: 0.18em;
      opacity: 0.92;
      font-weight: 500;
    }
    #timer {
  display: inline-block;
  transition: transform 0.5s cubic-bezier(.43,.22,.58,1.36), color 0.18s;
  will-change: transform, color;
  font-size: 1.18em;
  font-weight: bold;
  margin: 0 8px;
  text-shadow: 0 2px 12px #2226;
  border-radius: 10px;
  position: relative;
  z-index: 100;
}
    .timer-glitch {
      animation: glitchFall 0.5s cubic-bezier(.35,1.8,.35,.8) forwards, flicker 0.5s steps(2);
    }
    .timer-fly-back {
      animation: flyBack 1.1s cubic-bezier(.37,1.29,.34,.87) forwards;
    }
    @keyframes glitchFall {
      0% { filter: none; opacity: 1; }
      20% { filter: blur(2px) contrast(2) brightness(1.2); transform: translateY(0) scale(1.02) rotate(-5deg);}
      45% { filter: blur(2px) contrast(2) brightness(2); transform: translateY(30vh) scale(1.1) rotate(6deg);}
      60% { filter: blur(6px) contrast(3) brightness(2.2); transform: translateY(70vh) scale(1.12) rotate(-14deg);}
      100% { filter: blur(9px) contrast(3) brightness(2.4); transform: translateY(84vh) scale(1.18) rotate(16deg); opacity: 0.2;}
    }
    @keyframes flyBack {
      0% { opacity: 0.4; filter: blur(7px) brightness(2.2) contrast(2.1); transform: translateY(84vh) scale(1.18) rotate(9deg);}
      30% { opacity: 1; filter: blur(2px) brightness(1.2) contrast(1.2); transform: translateY(-8vh) scale(1.069) rotate(-7deg);}
      100% { opacity: 1; filter: none; transform: translateY(0) scale(1) rotate(0);}
    }
    @keyframes flicker {
      0% { opacity: 1; }
      20% { opacity: 0.7; }
      30% { opacity: 0.1; }
      40% { opacity: 1; }
      45% { opacity: 0.6; }
      50% { opacity: 0.25; }
      70% { opacity: 1; }
      80% { opacity: 0.6; }
      100% { opacity: 1; }
    }
    .timer-seconds {
      font-size: 0.28em;
      color: #bbb;
      font-weight: 600;
      margin-left: 3px;
      opacity: 0.77;
      vertical-align: middle;
      user-select: none;
    }
    #globalTimeBox {
      background: #21242b;
      border: 1.3px solid #5557;
      border-radius: 17px;
      color: #ffeb3b;
      font-size: 1.15em;
      font-weight: 600;
      box-shadow: 0 2px 10px #181a22a8;
      padding: 10px 12px 8px 12px;
      margin: 45px auto 18px auto;
      text-align: center;
      width: fit-content;
      min-width: 0;
      letter-spacing: 0.03em;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
    }
    #globalTimeLabel {
      color: #aaa;
      font-size: 0.97em;
      letter-spacing: 0.04em;
      font-weight: 500;
      margin-bottom: 2px;
    }
    #globalTimeValue {
      font-size: 1.18em;
      color: #43b581;
      font-weight: 800;
      letter-spacing: 0.04em;
      text-shadow: 0 2px 8px #181c20b0;
    }
    
    /* Command Panel Overlay Styles: vertical right sidebar, draggable */
    #commandPanelOverlay {
      position: fixed;
      top: 0; right: 0; bottom: 0;
      width: 350px;
      min-width: 220px;
      background: rgba(30,35,41,0.97);
      z-index: 3000;
      display: none;
      flex-direction: column;
      align-items: flex-end;
      justify-content: flex-start;
      user-select: none;
    }
    #commandPanel {
      background: #23272a;
      border-radius: 0 0 0 18px;
      box-shadow: 0 2px 30px #0009;
      width: 100%;
      height: 100vh;
      text-align: center;
      color: #fff;
      display: flex;
      flex-direction: column;
      gap: 22px;
      align-items: center;
      position: absolute;
      top: 0; left: 0;
      justify-content: flex-start;
      padding: 36px 30px 26px 30px;
      transition: box-shadow 0.2s;
      cursor: default;
    }
    .cpanel-close {
      position: absolute;
      top: 15px; right: 23px;
      color: #bbb; font-size: 1.2em; cursor: pointer;
      font-family: sans-serif;
      background: none;
      border: none;
      z-index: 20;
    }
    #cpanelDragHandle {
      cursor: move;
      width: 100%;
      height: 32px;
      position: absolute;
      left: 0; top: 0;
      z-index: 10;
      background: transparent;
    }
    @media (max-width: 600px) {
      #commandPanelOverlay {
        width: 100vw;
        min-width: unset;
        max-width: 100vw;
      }
      #commandPanel {
        min-width: unset;
        max-width: 100vw;
        border-radius: 0;
        padding: 18px 10vw 18px 10vw;
      }
      #cpanelDragHandle {
        height: 36px;
      }
    }
  </style>
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600,700,800&display=swap" rel="stylesheet">
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js";
    import { getDatabase, ref, get, set, update, onValue, increment, off } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-database.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-analytics.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDD2UtUAYNE47QhaUV4e2MPS30wWEDjGzk",
      authDomain: "web-timer-68ca7.firebaseapp.com",
      databaseURL: "https://web-timer-68ca7-default-rtdb.firebaseio.com",
      projectId: "web-timer-68ca7",
      storageBucket: "web-timer-68ca7.appspot.com",
      messagingSenderId: "876106729530",
      appId: "1:876106729530:web:3ce898e156061404eb4d03",
      measurementId: "G-V229PCNCFK"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    getAnalytics(app);

    let user = "", password = "";
    let userClicks = 0;
    let unsubGlobal = null, unsubUser = null, unsubLB = null;
    let timer = 0;
    let timerInterval = null;
    let timerDBListener = null;
    let updatingFromDB = false;
    let justWrote = false;
    let unsubGlobalTime = null;
    let lastThousand = 0;
    let animatingGlitch = false;


    // --- SINGLE TAB TIMER CONTROL ---
const tabChannel = new BroadcastChannel('timer-control');
let isActiveTab = false;
let tabId = Math.random().toString(36).slice(2);
let activeTabId = null;

// Listen for messages from other tabs
tabChannel.onmessage = (e) => {
  if (e.data.type === 'active-tab') {
    activeTabId = e.data.tabId;
    if (activeTabId !== tabId) {
      // Another tab is active, stop timer if running
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = null;
      // Optionally, visually indicate this tab is "view only"
      document.getElementById('timerLabel').textContent = "Time (view only)";
    }
  }
  if (e.data.type === 'request-active') {
    // Respond with our active status if we are active
    if (isActiveTab) {
      tabChannel.postMessage({ type: 'active-tab', tabId });
    }
  }
};

// On load, ask if another tab is active
tabChannel.postMessage({ type: 'request-active' });

// If no response in 300ms, become the active tab
setTimeout(() => {
  if (!activeTabId) {
    isActiveTab = true;
    activeTabId = tabId;
    tabChannel.postMessage({ type: 'active-tab', tabId });
    document.getElementById('timerLabel').textContent = "Time on site";
  }
}, 300);

// When closing, if we are the active tab, let others compete for active
window.addEventListener('beforeunload', () => {
  if (isActiveTab) {
    tabChannel.postMessage({ type: 'active-tab', tabId: null });
  }
});
    function saveSession(username, password) {
      try {
        localStorage.setItem("quiz_username", username);
        localStorage.setItem("quiz_password", password);
      } catch (e) {}
    }
    function clearSession() {
      try {
        localStorage.removeItem("quiz_username");
        localStorage.removeItem("quiz_password");
      } catch (e) {}
    }
    function getSession() {
      try {
        const username = localStorage.getItem("quiz_username");
        const password = localStorage.getItem("quiz_password");
        if (username && password) return {username, password};
      } catch (e) {}
      return null;
    }

    // ...existing code...
function startTimer() {
  let safeUsername = user.replace(/[.#$[\]]/g, '_');
  if (timerDBListener) timerDBListener();
  timerDBListener = onValue(ref(db, 'users/' + safeUsername + '/seconds'), snapshot => {
    if (snapshot.exists() && typeof snapshot.val() === "number") {
      if (timer !== snapshot.val() && !justWrote) {
        updatingFromDB = true;
        timer = snapshot.val();
        updateTimerDisplay();
        updatingFromDB = false;
      }
    }
  });
  get(ref(db, 'users/' + safeUsername + '/seconds')).then(snapshot => {
    timer = (snapshot.exists() && typeof snapshot.val() === "number") ? snapshot.val() : 0;
    lastThousand = Math.floor(timer / 1000);
    updateTimerDisplay();
    if (timerInterval) clearInterval(timerInterval);
    // Only run timer if this is the active tab
    if (isActiveTab) {
      timerInterval = setInterval(() => {
        timer++;
        updateTimerDisplay();
        justWrote = true;
        update(ref(db, 'users/' + safeUsername), {seconds: timer}).then(() => {
          justWrote = false;
          update(ref(db, 'meta'), { global_time: increment(1) });
        });
      }, 1000);
    }
  });
}
// ...existing code...

    function updateTimerDisplay() {
      const timerElem = document.getElementById("timer");
      let newThousand = Math.floor(timer / 1000);
      if (newThousand > lastThousand && !animatingGlitch) {
        triggerGlitchDrop();
        lastThousand = newThousand;
      }
      timerElem.textContent = timer;
      if (!animatingGlitch) {
        timerElem.style.color = `hsl(${Math.floor(Math.random()*360)},95%,60%)`;
        const offset = Math.floor(Math.random() * 101) - 50;
        timerElem.style.transform = `translateX(${offset}px)`;
      } else {
        timerElem.style.transform = '';
        timerElem.style.color = '';
      }
    }

    function triggerGlitchDrop() {
      const timerElem = document.getElementById("timer");
      if (animatingGlitch) return;
      animatingGlitch = true;
      timerElem.classList.remove("timer-fly-back");
      timerElem.classList.add("timer-glitch");
      setTimeout(() => {
        timerElem.classList.remove("timer-glitch");
        timerElem.classList.add("timer-fly-back");
        setTimeout(() => {
          timerElem.classList.remove("timer-fly-back");
          animatingGlitch = false;
        }, 1100);
      }, 500);
    }

    window.triggerGlitchDrop = triggerGlitchDrop;

let bounceTimerActive = false;
let bounceTimerInterval = null;

function startBounceTimer() {
  if (bounceTimerActive) return;
  bounceTimerActive = true;
  const timerElem = document.getElementById("timer");

  function bounce() {
    // Get current X transform from updateTimerDisplay
    const match = timerElem.style.transform.match(/translateX\([^)]+\)/);
    const xTransform = match ? match[0] : "translateX(0px)";
    timerElem.style.transform = `${xTransform} translateY(-30px)`;
    setTimeout(() => {
      timerElem.style.transform = `${xTransform} translateY(0)`;
    }, 700); // 0.7s up, then smoothly back
  }

  bounceTimerInterval = setInterval(bounce, 10000); // every 10 seconds
  bounce(); // initial bounce
}

function stopBounceTimer() {
  bounceTimerActive = false;
  clearInterval(bounceTimerInterval);
  bounceTimerInterval = null;
  const timerElem = document.getElementById("timer");
  // Reset to just the X transform (from updateTimerDisplay)
  const match = timerElem.style.transform.match(/translateX\([^)]+\)/);
  timerElem.style.transform = match ? match[0] : "translateX(0px)";
}
// Make typing "panel" in the console open the panel (no parentheses needed)
window.panel = new Proxy(function openPanelProxy() {
  document.getElementById('commandPanelOverlay').style.display = 'flex';
}, {
  apply(target, thisArg, argumentsList) {
    target();
    return undefined;
  },
  get(target, prop) {
    target();
    return () => '';
  }
});
function bounceTimerOnce() {
  const timerElem = document.getElementById("timer");
  // Get current X transform from updateTimerDisplay
  const match = timerElem.style.transform.match(/translateX\([^)]+\)/);
  const xTransform = match ? match[0] : "translateX(0px)";
  timerElem.style.transform = `${xTransform} translateY(-30px)`;
  setTimeout(() => {
    timerElem.style.transform = `${xTransform} translateY(0)`;
  }, 700);
}
// Make typing "panel" in the console open the panel (no parentheses needed)

    function closePanel() {
      document.getElementById('commandPanelOverlay').style.display = 'none';
      resetPanelPosition();
    }
window.panel = new Proxy(function openPanelProxy() {
  document.getElementById('commandPanelOverlay').style.display = 'flex';
}, {
  apply(target, thisArg, argumentsList) {
    target();
    return undefined;
  },
  get(target, prop) {
    target();
    return () => '';
  }
});
let noGravity = false;
let gravityInterval = null;
let floatingElems = [];

function setNoGravityMode(on) {
  noGravity = on;
  document.getElementById('noGravityBtn').textContent = `No Gravity: ${noGravity ? "On" : "Off"}`;
  if (noGravity) {
    floatingElems = Array.from(document.querySelectorAll('body > *:not(#commandPanelOverlay):not(script):not(style)'));
    floatingElems.forEach(el => {
      el.style.position = 'absolute';
      el.style.cursor = 'grab';
      // Store the original random velocity as "normal" speed
      if (!el.dataset.normalFvx || !el.dataset.normalFvy) {
        let angle = Math.random() * 2 * Math.PI;
        let speed = 6 + Math.random() * 4;
        el.dataset.normalFvx = Math.cos(angle) * speed;
        el.dataset.normalFvy = Math.sin(angle) * speed;
      }
      el.dataset.fvx = el.dataset.fvx || el.dataset.normalFvx;
      el.dataset.fvy = el.dataset.fvy || el.dataset.normalFvy;
      el.dataset.dragging = '0';
      if (!el.style.left) el.style.left = (el.offsetLeft || 100) + "px";
      if (!el.style.top) el.style.top = (el.offsetTop || 100) + "px";
      el.onmousedown = function(e) {
        e.preventDefault();
        el.dataset.dragging = '1';
        el.style.cursor = 'grabbing';
        let startX = e.clientX, startY = e.clientY;
        let origLeft = parseFloat(el.style.left) || 0;
        let origTop = parseFloat(el.style.top) || 0;
        let lastX = startX, lastY = startY, lastTime = Date.now();
        let vx = 0, vy = 0;
        document.onmousemove = function(ev) {
          let dx = ev.clientX - startX;
          let dy = ev.clientY - startY;
          el.style.left = (origLeft + dx) + "px";
          el.style.top = (origTop + dy) + "px";
          // Track velocity for inertia
          let now = Date.now();
          let dt = now - lastTime;
          if (dt > 0) {
            vx = (ev.clientX - lastX) / dt * 16;
            vy = (ev.clientY - lastY) / dt * 16;
            lastX = ev.clientX;
            lastY = ev.clientY;
            lastTime = now;
          }
        };
        document.onmouseup = function() {
          el.dataset.dragging = '0';
          el.style.cursor = 'grab';
          el.dataset.fvx = vx;
          el.dataset.fvy = vy;
          document.onmousemove = null;
          document.onmouseup = null;
        };
      };
    });
    if (!gravityInterval) gravityInterval = setInterval(updateFloatingElems, 30);
  } else {
    if (gravityInterval) clearInterval(gravityInterval);
    gravityInterval = null;
    floatingElems.forEach(el => {
      el.style.position = '';
      el.style.left = '';
      el.style.top = '';
      el.style.cursor = '';
      delete el.dataset.fvx;
      delete el.dataset.fvy;
      delete el.dataset.normalFvx;
      delete el.dataset.normalFvy;
      delete el.dataset.dragging;
      el.onmousedown = null;
    });
    floatingElems = [];
  }
}

function updateFloatingElems() {
  floatingElems.forEach(el => {
    if (el.dataset.dragging === '1') return;
    let left = parseFloat(el.style.left) || 0;
    let top = parseFloat(el.style.top) || 0;
    let vx = parseFloat(el.dataset.fvx) || 0;
    let vy = parseFloat(el.dataset.fvy) || 0;
    let normalVx = parseFloat(el.dataset.normalFvx) || 0;
    let normalVy = parseFloat(el.dataset.normalFvy) || 0;
    // Slowly interpolate velocity back to normal
    vx += (normalVx - vx) * 0.01;
    vy += (normalVy - vy) * 0.01;
    const rect = el.getBoundingClientRect();
    const w = rect.width, h = rect.height;
    let cx = left + w / 2, cy = top + h / 2;
    cx += vx; cy += vy;
    if (cx - w / 2 < 0) { cx = w / 2; vx *= -1; }
    if (cx + w / 2 > window.innerWidth) { cx = window.innerWidth - w / 2; vx *= -1; }
    if (cy - h / 2 < 0) { cy = h / 2; vy *= -1; }
    if (cy + h / 2 > window.innerHeight) { cy = window.innerHeight - h / 2; vy *= -1; }
    el.style.left = (cx - w / 2) + "px";
    el.style.top = (cy - h / 2) + "px";
    el.dataset.fvx = vx;
    el.dataset.fvy = vy;
  });
}

document.addEventListener('keydown', function(e) {
  if (e.key === "Escape") closePanel();
});

function stopTimerAndSave() {
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
  if (timerDBListener) timerDBListener();
      if (user) {
        let safeUsername = user.replace(/[.#$[\]]/g, '_');
        update(ref(db, 'users/' + safeUsername), {seconds: timer});
      }
    }

    function listenGlobalTime() {
      if (unsubGlobalTime) unsubGlobalTime();
      unsubGlobalTime = onValue(ref(db, 'meta/global_time'), snap => {
        let v = snap.exists() && typeof snap.val() === "number" ? snap.val() : 0;
        document.getElementById('globalTimeValue').textContent = v.toLocaleString();
      });
    }
function startTimerWhenReady() {
  // Wait until activeTabId is set (either by another tab or by ourselves)
  let waited = 0;
  function tryStart() {
    if (isActiveTab !== undefined && (isActiveTab || activeTabId)) {
      startTimer();
    } else if (waited < 1000) {
      waited += 50;
      setTimeout(tryStart, 50);
    }
  }
  tryStart();
}
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById('showPasswordCheckbox').onchange = function() {
        let loginVis = document.getElementById('loginSection').style.display !== "none";
        let pwdField = loginVis ? document.getElementById('loginPassword') : document.getElementById('createPassword');
        pwdField.type = this.checked ? "text" : "password";
      };

      document.getElementById('accountSwitch').onclick = function() {
        document.getElementById('loginSection').style.display = "none";
        document.getElementById('createSection').style.display = "block";
        document.getElementById('errorMsg').textContent = '';
        document.getElementById('showPasswordBox').style.display = "block";
      };
      document.getElementById('accountSwitchBack').onclick = function() {
        document.getElementById('loginSection').style.display = "block";
        document.getElementById('createSection').style.display = "none";
        document.getElementById('errorMsg').textContent = '';
        document.getElementById('showPasswordBox').style.display = "block";
      };

      document.getElementById('createBtn').onclick = function() {
        const uname = document.getElementById('createUsername').value.trim();
        const pw = document.getElementById('createPassword').value;
        document.getElementById('errorMsg').textContent = '';
        if (!uname || !pw) {
          document.getElementById('errorMsg').textContent = "Enter username and password!";
          return;
        }
        const safeUsername = uname.replace(/[.#$[\]]/g, '_');
        get(ref(db, 'users/' + safeUsername)).then(snapshot => {
          if (snapshot.exists()) {
            document.getElementById('errorMsg').textContent = "Username already exists!";
          } else {
            set(ref(db, 'users/' + safeUsername), {clicks: 0, password: pw, seconds: 0});
            user = uname;
            password = pw;
            saveSession(user, password);
            showClickSection();
          }
        });
      };

      document.getElementById('loginBtn').onclick = function() {
        const uname = document.getElementById('loginUsername').value.trim();
        const pw = document.getElementById('loginPassword').value;
        document.getElementById('errorMsg').textContent = '';
        document.getElementById('showPasswordBox').style.display = "block";
        if (!uname || !pw) {
          document.getElementById('errorMsg').textContent = "Enter username and password!";
          return;
        }
        const safeUsername = uname.replace(/[.#$[\]]/g, '_');
        get(ref(db, 'users/' + safeUsername)).then(snapshot => {
          if (!snapshot.exists()) {
            document.getElementById('errorMsg').textContent = "Username not found!";
          } else if (snapshot.val().password !== pw) {
            document.getElementById('errorMsg').textContent = "Incorrect password!";
          } else {
            user = uname;
            password = pw;
            saveSession(user, password);
            showClickSection();
          }
        });
      };

      function showClickSection() {
  document.getElementById('accountBox').style.display = "none";
  document.getElementById('clickSection').style.display = "block";
  document.getElementById('currentUser').innerText = user;
  listenGlobal();
  listenUser();
  listenLeaderboard();
  startTimerWhenReady();
  listenGlobalTime();
}
      function listenGlobal() {
        if (unsubGlobal) unsubGlobal();
        unsubGlobal = onValue(ref(db, 'meta/global'), snap => {
          const v = snap.exists() && snap.val() && typeof snap.val().count === "number" ? snap.val().count : 0;
          document.getElementById('globalCount').textContent = v;
        });
      }
      function listenUser() {
        if (unsubUser) unsubUser();
        const safeUsername = user.replace(/[.#$[\]]/g, '_');
        unsubUser = onValue(ref(db, 'users/' + safeUsername), snap => {
          userClicks = snap.exists() && snap.val() && typeof snap.val().clicks === "number" ? snap.val().clicks : 0;
          document.getElementById('yourCount').textContent = userClicks;
        });
      }
      function listenLeaderboard() {
        if (unsubLB) unsubLB();
        unsubLB = onValue(ref(db, 'users'), snap => {
          const entries = [];
          snap.forEach(child => {
            entries.push({ name: child.key, clicks: child.val().clicks || 0, seconds: child.val().seconds || 0 });
          });
          entries.sort((a, b) => b.clicks - a.clicks);
          const tbody = document.getElementById('leaderboardBody');
          tbody.innerHTML = "";
          entries.slice(0, 15).forEach((entry, i) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${i + 1}</td>
              <td>${entry.name}</td>
              <td>${entry.clicks}</td>
              <td>${typeof entry.seconds === "number" ? entry.seconds : 0}</td>`;
            tbody.appendChild(tr);
          });
          if (entries.length === 0) {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td colspan="4" style="text-align:center;">No scores yet!</td>`;
            tbody.appendChild(tr);
          }
        });
      }

      document.getElementById('clickBtn').onclick = function() {
        const safeUsername = user.replace(/[.#$[\]]/g, '_');
        update(ref(db), {
          '/meta/global/count': increment(1),
          ['/users/' + safeUsername + '/clicks']: increment(1)
        });
      };

      document.getElementById('logoutBtn').onclick = function() {
        stopTimerAndSave();
        clearSession();
        user = "";
        password = "";
        document.getElementById('clickSection').style.display = "none";
        document.getElementById('accountBox').style.display = "block";
        document.getElementById('loginSection').style.display = "block";
        document.getElementById('createSection').style.display = "none";
        document.getElementById('showPasswordBox').style.display = "block";
        document.getElementById('errorMsg').textContent = '';
        if (unsubGlobal) unsubGlobal();
        if (unsubUser) unsubUser();
        if (unsubLB) unsubLB();
        if (unsubGlobalTime) unsubGlobalTime();
      };

      document.getElementById('showPasswordBox').style.display = "block";
      const session = getSession();
      if (session) {
        user = session.username;
        password = session.password;
        get(ref(db, 'users/' + user.replace(/[.#$[\]]/g, '_'))).then(snapshot => {
          if (snapshot.exists() && snapshot.val().password === password) {
            showClickSection();
          } else {
            clearSession();
            document.getElementById('accountBox').style.display = "block";
            document.getElementById('clickSection').style.display = "none";
          }
        });
      } else {
        document.getElementById('accountBox').style.display = "block";
        document.getElementById('clickSection').style.display = "none";
      }

      listenGlobalTime();

      document.getElementById('dropBtn').onclick = triggerGlitchDrop;
      document.getElementById('bounceTimerBtn').onclick = bounceTimerOnce;
      document.getElementById('cpanelCloseBtn').onclick = closePanel;
      document.getElementById('noGravityBtn').onclick = function() {
  setNoGravityMode(!noGravity);
};
      startBounceTimer();
    });
    document.getElementById('confettiBtn').onclick = function() {
  const panel = document.getElementById('commandPanel');
  const rect = panel.getBoundingClientRect();
  const panelLeft = rect.left;
  const panelBottom = rect.bottom;
  const panelWidth = rect.width;
  const colors = ['#ffeb3b','#43b581','#ff5555','#5865f2','#fff','#ffb347','#ff69b4','#00e6e6'];
  for(let i=0;i<42;i++){
    const conf = document.createElement('div');
    const size = 8 + Math.random()*10;
    conf.style.position = 'fixed';
    conf.style.left = (panelLeft + Math.random()*panelWidth) + 'px';
    conf.style.top = (panelBottom-8) + 'px';
    conf.style.width = size+'px';
    conf.style.height = size+'px';
    conf.style.background = colors[Math.floor(Math.random()*colors.length)];
    conf.style.borderRadius = Math.random()<0.5 ? '50%' : '2px';
    conf.style.zIndex = 99999;
    conf.style.pointerEvents = 'none';
    conf.style.opacity = 0.85;
    conf.style.transition = 'transform 1.2s cubic-bezier(.2,1.2,.4,1), opacity 1.2s';
    document.body.appendChild(conf);
    setTimeout(()=>{
      const angle = (Math.random()*Math.PI) + Math.PI/2;
      const dist = 120 + Math.random()*180;
      const dx = Math.cos(angle)*dist;
      const dy = -Math.abs(Math.sin(angle))*dist - 60;
      conf.style.transform = `translate(${dx}px,${dy}px) rotate(${Math.random()*360}deg)`;
      conf.style.opacity = 0;
    },10);
    setTimeout(()=>conf.remove(),1400);
  }
};

  </script>
</head>
<body>
  <div class="quiz-box">
    <h2>Random Game</h2>
    <div id="accountBox" style="display:block;">
      <div id="loginSection">
        <label for="loginUsername">Username:</label>
        <input type="text" id="loginUsername" autocomplete="username" required>
        <label for="loginPassword">Password:</label>
        <input type="password" id="loginPassword" autocomplete="current-password" required>
        <button type="button" id="loginBtn">Login</button>
        <div id="toCreate" style="margin-top:7px;"><span id="accountSwitch">Create account</span></div>
      </div>
      <div id="createSection" style="display:none;">
        <label for="createUsername">Username:</label>
        <input type="text" id="createUsername" autocomplete="username" required>
        <label for="createPassword">Password:</label>
        <input type="password" id="createPassword" autocomplete="new-password" required>
        <button type="button" id="createBtn">Create Account</button>
        <div id="toLogin" style="margin-top:7px;"><span id="accountSwitchBack">Already have an account? Login</span></div>
      </div>
      <div id="errorMsg"></div>
      <div id="showPasswordBox">
        <input type="checkbox" id="showPasswordCheckbox">
        <label id="showPasswordLabel" for="showPasswordCheckbox">Show password</label>
        <div id="rememberMsg">
          Make sure to use a password you remember.
        </div>
      </div>
    </div>
    <div id="clickSection" style="display:none;">
      <div style="margin-bottom: 10px;">Welcome, <span id="currentUser"></span>! <span id="logoutBtn">Logout</span></div>
      <div id="timerBox">
        <span id="timerLabel">Time on site</span>
        <span id="timer">0</span>
        <span class="timer-seconds">seconds</span>
      </div>
      <div class="big-count">
        <div>Global Count</div>
        <div id="globalCount">0</div>
      </div>
      <button id="clickBtn" style="font-size: 1.5em; margin: 12px 0;">Click Me!</button>
      <div style="margin-top: 15px;">
        Your Clicks: <span id="yourCount">0</span>
      </div>
    </div>
  </div>
  <div id="leaderboard">
    <h3>Global Leaderboard</h3>
    <table>
      <thead>
        <tr>
          <th>Rank</th>
          <th>User</th>
          <th>Clicks</th>
          <th>Time (s)</th>
        </tr>
      </thead>
      <tbody id="leaderboardBody"></tbody>
    </table>
  </div>
  <div id="globalTimeBox">
    <span id="globalTimeLabel">Global time on site</span>
    <span id="globalTimeValue">0</span>
    <span style="font-size:0.9em;color:#bbb;font-weight:600;opacity:0.69;">seconds</span>
  </div>
  <!-- Command Panel Overlay: draggable + panel command enabled -->
  <div id="commandPanelOverlay">
  <div id="commandPanel">
    <button class="cpanel-close" id="cpanelCloseBtn" title="Close Panel"
      onclick="document.getElementById('commandPanelOverlay').style.display = 'none';">×</button>
    <h2 style="margin-top:26px;">Command Panel</h2>
    <button id="dropBtn" class="cpanel-btn">Drop Down</button>
    <button id="bounceTimerBtn" class="cpanel-btn">Bounce Timer</button>
    <button id="noGravityBtn" class="cpanel-btn">No Gravity: Off</button>
<button id="confettiBtn" class="cpanel-btn">🎉 Confetti</button> 
<button id="nigerianNuggetBtn" class="cpanel-btn">Nigerian Nugget</button>
    <button id="idonohtingBtn" class="cpanel-btn">I do nothing</button>

 </div>
</div>
</body>
</html>

